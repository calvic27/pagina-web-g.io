<!DOCTYPE html>
<html>
<head>
  <title>Panel de Finanzas</title>
  <meta charset="UTF-8">
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <h2>Iniciar sesión para acceder a tu panel</h2>
  <button onclick="login()">Iniciar sesión con Google</button>

  <script>
    // ✅ Tu configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCxCWZRHoEvayokHNkoavBaa8_o7vr1SiE",
      authDomain: "drg-app-a654e.firebaseapp.com",
      projectId: "drg-app-a654e",
      storageBucket: "drg-app-a654e.appspot.com",
      messagingSenderId: "853577402845",
      appId: "1:853577402845:web:9c7ae221db8bf986cc0e34",
      measurementId: "G-PWZF6M6NKZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ⏳ Detecta usuario logueado (también si recarga la página)
    auth.onAuthStateChanged(user => {
      if (user) {
        cargarPanelUsuario(user.uid, user.displayName);
      }
    });

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          cargarPanelUsuario(user.uid, user.displayName);
        })
        .catch(error => {
          console.error("Error en login:", error);
          alert("Fallo en login. Revisa consola.");
        });
    }

    function cargarPanelUsuario(uid, nombre) {
      document.body.innerHTML = `
        <h2>Bienvenido, ${nombre}</h2>
        <form onsubmit="guardarCategoria('${uid}'); return false;">
          <input type="text" id="categoria" placeholder="Categoría" required />
          <input type="number" id="monto" placeholder="Monto" required />
          <button type="submit">Guardar</button>
        </form>
        <canvas id="grafico" width="400" height="400" style="margin-top:20px;"></canvas>
        <button onclick="logout()">Cerrar sesión</button>
      `;
      cargarDatos(uid);
    }

    function guardarCategoria(uid) {
      const categoria = document.getElementById("categoria").value;
      const monto = parseFloat(document.getElementById("monto").value);
      db.collection("usuarios").doc(uid).collection("categorias").doc(categoria).set({
        monto: monto
      }).then(() => {
        alert("Guardado correctamente");
        cargarDatos(uid);
      });
    }

    function cargarDatos(uid) {
      db.collection("usuarios").doc(uid).collection("categorias").get()
        .then(snapshot => {
          const datos = [];
          snapshot.forEach(doc => datos.push({ nombre: doc.id, monto: doc.data().monto }));
          dibujarGrafico(datos);
        });
    }

    function dibujarGrafico(data) {
      const ctx = document.getElementById('grafico').getContext('2d');
      const labels = data.map(c => c.nombre);
      const valores = data.map(c => c.monto);

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: valores,
            backgroundColor: ['green', 'red', 'orange', 'blue', 'purple']
          }]
        }
      });
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }
  </script>
</body>
</html>

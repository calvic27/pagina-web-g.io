<!DOCTYPE html>
<html>
<head>
  <title>Mis Finanzas</title>
  <meta charset="UTF-8">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    input, select { width: 100%; box-sizing: border-box; }
    #mensaje { margin-top: 10px; color: green; }
    button { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Mis Finanzas</h2>
  <button onclick="logout()">Cerrar sesiÃ³n</button>

  <form onsubmit="guardarEntradas(); return false;">
    <table id="tablaFinanzas">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Fuente</th>
          <th>Glosa</th>
          <th>Monto</th>
          <th>% Ahorro</th>
          <th>Ahorro Neto</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>
    <button type="button" onclick="agregarFila()">âž• Agregar Ingreso o Gasto</button>
    <button type="submit">ðŸ’¾ Guardar Todo</button>
  </form>

  <div id="mensaje"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCxCWZRHoEvayokHNkoavBaa8_o7vr1SiE",
      authDomain: "drg-app-a654e.firebaseapp.com",
      projectId: "drg-app-a654e",
      storageBucket: "drg-app-a654e.appspot.com",
      messagingSenderId: "853577402845",
      appId: "1:853577402845:web:9c7ae221db8bf986cc0e34",
      measurementId: "G-PWZF6M6NKZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let uid = null;

    const fuentesIngreso = ["Trabajo", "Negocio", "Inversiones", "Otros"];
    const fuentesEgreso = ["Hogar", "Salud", "AlimentaciÃ³n", "Estilo de vida", "InversiÃ³n", "Otros"];
    const glosasIngreso = ["sueldo", "negocio", "ventas", "otros"];
    const glosasEgreso = [
      "Gastos de hogar / familia",
      "Categoria de gastos de salud",
      "Gastos de alimentacion",
      "Gastos de estilo de vida",
      "Gastos de inversion",
      "Gasto otros"
    ];

    auth.onAuthStateChanged(user => {
      if (user) {
        uid = user.uid;
        agregarFila(); // AÃ±adir la primera fila al cargar
      } else {
        window.location.href = "../index.html";
      }
    });

    function agregarFila() {
      const tbody = document.getElementById("cuerpoTabla");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="date" required></td>
        <td>
          <select onchange="actualizarFuentesYGlosas(this)" required>
            <option value="Ingreso">Ingreso</option>
            <option value="Egreso">Egreso</option>
          </select>
        </td>
        <td><select required></select></td>
        <td><select required></select></td>
        <td><input type="number" step="0.01" required></td>
        <td><input type="number" value="10" step="0.01"></td>
        <td><span>0.00</span></td>
      `;
      tbody.appendChild(row);
      actualizarFuentesYGlosas(row.querySelector("select"));
      agregarEventos(row);
    }

    function actualizarFuentesYGlosas(select) {
      const row = select.closest("tr");
      const tipo = select.value;
      const fuentes = tipo === "Ingreso" ? fuentesIngreso : fuentesEgreso;
      const glosas = tipo === "Ingreso" ? glosasIngreso : glosasEgreso;

      const fuenteSelect = row.cells[2].querySelector("select");
      const glosaSelect = row.cells[3].querySelector("select");

      fuenteSelect.innerHTML = "";
      glosaSelect.innerHTML = "";

      fuentes.forEach(op => {
        const option = document.createElement("option");
        option.value = op;
        option.textContent = op;
        fuenteSelect.appendChild(option);
      });

      glosas.forEach(op => {
        const option = document.createElement("option");
        option.value = op;
        option.textContent = op;
        glosaSelect.appendChild(option);
      });
    }

    function agregarEventos(row) {
      const montoInput = row.cells[4].querySelector("input");
      const porcentajeInput = row.cells[5].querySelector("input");
      [montoInput, porcentajeInput].forEach(input =>
        input.addEventListener("input", () => calcularAhorro(row))
      );
    }

    function calcularAhorro(row) {
      const monto = parseFloat(row.cells[4].querySelector("input").value) || 0;
      const porcentaje = parseFloat(row.cells[5].querySelector("input").value) || 0;
      const ahorro = (monto * porcentaje / 100).toFixed(2);
      row.cells[6].querySelector("span").textContent = ahorro;
    }

    function guardarEntradas() {
      const filas = document.querySelectorAll("#cuerpoTabla tr");
      const batch = db.batch();

      filas.forEach(row => {
        const fecha = row.cells[0].querySelector("input").value;
        const tipo = row.cells[1].querySelector("select").value;
        const fuente = row.cells[2].querySelector("select").value;
        const glosa = row.cells[3].querySelector("select").value;
        const monto = parseFloat(row.cells[4].querySelector("input").value);
        const porcentaje = parseFloat(row.cells[5].querySelector("input").value);
        const ahorro = parseFloat(row.cells[6].querySelector("span").textContent);

        const ref = db.collection("usuarios").doc(uid).collection("finanzas").doc();
        batch.set(ref, { fecha, tipo, fuente, glosa, monto, porcentaje, ahorro });
      });

      batch.commit().then(() => {
        document.getElementById("mensaje").innerText = "âœ… Registros guardados con Ã©xito.";
      });
    }

    function logout() {
      auth.signOut().then(() => window.location.href = "../index.html");
    }
  </script>
</body>
</html>
